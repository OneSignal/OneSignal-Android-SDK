name: Build and Test SDK

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    branches: ["**"]

env:
  DIFF_COVERAGE_THRESHOLD: "80"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: "[Checkout] Repo"
        uses: actions/checkout@v4
      - name: "[Setup] Project"
        uses: ./.github/actions/project-setup
      - name: "[Code Formatting] Spotless"
        working-directory: OneSignalSDK
        run: |
          ./gradlew spotlessCheck --console=plain
      - name: "[Static Code Analysis] Detekt"
        working-directory: OneSignalSDK
        run: |
          ./gradlew detekt --console=plain
      - name: "[Test] SDK Unit Tests"
        working-directory: OneSignalSDK
        run: |
          ./gradlew testDebugUnitTest --console=plain --continue
      - name: "[Diff Coverage] Check for bypass"
        id: coverage_bypass
        run: |
          # Check if PR has Skip Coverage Check label
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            LABELS="${{ toJson(github.event.pull_request.labels.*.name) }}"
            if echo "$LABELS" | grep -qiE "Skip Coverage Check|skip-coverage-check"; then
              echo "bypass=true" >> $GITHUB_OUTPUT
              echo "reason=PR has 'Skip Coverage Check' label" >> $GITHUB_OUTPUT
              echo "âš ï¸ Coverage check will not fail build (PR has 'Skip Coverage Check' label)"
              echo "   Coverage will still be checked and reported"
            else
              echo "bypass=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "bypass=false" >> $GITHUB_OUTPUT
          fi
      - name: "[Diff Coverage] Check coverage"
        working-directory: OneSignalSDK
        run: |
          # Use the shared coverage check script for consistency
          # Generate markdown report for PR comments
          # If bypassed, still run the check but don't fail the build
          set +e  # Don't exit on error - we want to generate the report even if coverage fails
          if [ "${{ steps.coverage_bypass.outputs.bypass }}" = "true" ]; then
            SKIP_COVERAGE_CHECK=true GENERATE_MARKDOWN=true DIFF_COVERAGE_THRESHOLD=$DIFF_COVERAGE_THRESHOLD ./coverage/checkCoverage.sh
          else
            GENERATE_MARKDOWN=true DIFF_COVERAGE_THRESHOLD=$DIFF_COVERAGE_THRESHOLD ./coverage/checkCoverage.sh
          fi
          COVERAGE_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          # Check if markdown report was generated
          if [ -f "diff_coverage.md" ]; then
            echo "âœ… Coverage report generated"
          else
            echo "âš ï¸ Coverage report not generated"
          fi

          # Only fail the build if coverage is below threshold AND not bypassed
          if [ "${{ steps.coverage_bypass.outputs.bypass }}" != "true" ] && [ $COVERAGE_EXIT_CODE -ne 0 ]; then
            echo "âŒ Coverage check failed - build will fail"
            exit $COVERAGE_EXIT_CODE
          elif [ "${{ steps.coverage_bypass.outputs.bypass }}" = "true" ]; then
            echo "âš ï¸ Coverage check completed (bypassed - build will not fail)"
            exit 0
          else
            echo "âœ… Coverage check passed"
            exit 0
          fi
      - name: Comment PR with coverage summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'OneSignalSDK/diff_coverage.md';
            if (fs.existsSync(path)) {
              const content = fs.readFileSync(path, 'utf8');
              const body = `## ðŸ“Š Diff Coverage Report\n\n${content}\n\nðŸ“¥ [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
              
              // Find existing comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.data.find(comment => 
                comment.user.type === 'Bot' && comment.body.includes('Diff Coverage Report')
              );
              
              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: body
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            }
      - name: Unit tests results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: unit-tests-results
          path: OneSignalSDK/unittest/build
